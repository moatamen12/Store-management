<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout :: head"></head>
<body>
<div th:replace="fragments/layout :: main(content=~{::content}, pageTitle=#{admin.title})">
    <div th:fragment="content">

        <div th:replace="fragments/layout :: alertMessage"></div>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="fw-bold text-dark" th:text="#{admin.manage.users}">Manage Users</h2>
                <p class="text-secondary mb-0" th:text="#{admin.users.description}">Overview of all system accounts and permissions.</p>
            </div>
            <a th:href="@{/admin/addUser}" class="btn btn-primary shadow-sm rounded-3 px-4">
                <i class="bi bi-plus-lg me-2"></i><span th:text="#{admin.add.new.user}">Add New User</span>
            </a>
        </div>
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <!--search -->

            <div class="card-header bg-white border-bottom border-light p-4">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <div class="position-relative">
                            <span class="position-absolute top-50 start-0 translate-middle-y ps-3 text-muted">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" class="form-control form-control-lg border-light bg-light ps-5 rounded-pill"
                                   id="searchInput" th:placeholder="#{admin.search.users}">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                        <tr class="text-muted text-uppercase small" style="letter-spacing: 0.5px;">
                            <th class="ps-4 py-3">ID</th>
                            <th class="py-3" th:text="#{admin.table.user}">User</th>
                            <th class="py-3" th:text="#{admin.table.role}">Role</th>
                            <th class="py-3 text-end pe-4" th:text="#{admin.table.actions}">Actions</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="user : ${users}" class="border-light">
                            <td class="ps-4 fw-semibold text-secondary" th:text="${'#' + user.id}"></td>

                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                                         style="width: 40px; height: 40px; font-weight: bold;">
                                        <span th:text="${#strings.substring(user.nom, 0, 1)}">A</span>
                                    </div>
                                    <div>
                                        <div class="fw-bold text-dark" th:text="${user.nom + ' ' + user.prenom}"></div>
                                        <div class="small text-muted" th:text="${user.email}"></div>
                                    </div>
                                </div>
                            </td>

                            <td>
                                    <span class="badge rounded-pill px-3 py-2 fw-normal"
                                          th:classappend="${user.role == 'ADMIN' ? 'bg-danger-subtle text-danger border border-danger-subtle' :
                                                           (user.role == 'SECRETAIRE_GENERAL' ? 'bg-warning-subtle text-warning-emphasis border border-warning-subtle' :
                                                           'bg-success-subtle text-success border border-success-subtle')}"
                                          th:text="${user.role}">
                                    </span>
                            </td>

                            <td class="text-end pe-4">
                                <div class="btn-group">
                                    <a th:href="@{/admin/editUser/{id}(id=${user.id})}"
                                       class="btn btn-light btn-sm text-primary rounded-2 me-2"
                                       th:title="#{admin.button.edit}">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>
                                    <form th:action="@{/admin/deleteUser/{id}(id=${user.id})}" method="post" th:onsubmit="|return confirm('#{admin.confirm.delete}');|">
                                        <button type="submit" class="btn btn-light btn-sm text-danger rounded-2" th:title="#{admin.button.delete}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-footer bg-white border-top border-light p-3">
                <div class="d-flex justify-content-between align-items-center">
                    <div class="text-muted small">
                        <span th:text="#{text.rows.per.page}">Rows per page:</span>
                        <select id="pageSize" class="form-select form-select-sm d-inline-block border-0 bg-light" style="width:auto;">
                            <option value="5">5</option>
                            <option value="10" selected>10</option>
                            <option value="25">25</option>
                        </select>
                    </div>
                    <nav>
                        <ul id="pager" class="pagination pagination-sm mb-0 gap-1"></ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    (function () {
        const searchInput = document.getElementById('searchInput');
        const tableBody = document.querySelector('table tbody');
        const pageSizeSelect = document.getElementById('pageSize');
        const pager = document.getElementById('pager');

        if (!tableBody) return;

        let currentPage = 1;

        function getFilteredRows() {
            const searchTerm = (searchInput.value || '').toLowerCase();
            const rows = Array.from(tableBody.querySelectorAll('tr'));
            return rows.filter(row => {
                const text = row.textContent.toLowerCase();
                return text.includes(searchTerm);
            });
        }

        function renderPage(page = 1) {
            currentPage = page;
            const pageSize = parseInt(pageSizeSelect.value, 10) || 10;
            const allRows = Array.from(tableBody.querySelectorAll('tr'));
            const filtered = getFilteredRows();
            allRows.forEach(r => r.style.display = 'none');

            const total = filtered.length;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            const start = (page - 1) * pageSize;
            const end = start + pageSize;
            filtered.slice(start, end).forEach(r => r.style.display = '');

            renderPager(totalPages);
        }

        function renderPager(totalPages) {
            pager.innerHTML = '';
            const makeLi = (text, page, disabled, active) => {
                const li = document.createElement('li');
                li.className = 'page-item' + (disabled ? ' disabled' : '');
                const a = document.createElement('a');
                a.className = 'page-link rounded-2 border-0 ' + (active ? 'bg-primary text-white' : 'text-secondary');
                a.href = '#';
                a.textContent = text;
                a.onclick = (e) => { e.preventDefault(); if (!disabled) renderPage(page); };
                li.appendChild(a);
                return li;
            };

            pager.appendChild(makeLi('«', Math.max(1, currentPage - 1), currentPage === 1, false));
            const maxWindow = 5;
            let start = Math.max(1, currentPage - Math.floor(maxWindow / 2));
            let end = Math.min(totalPages, start + maxWindow - 1);
            if (end - start + 1 < maxWindow) start = Math.max(1, end - maxWindow + 1);

            for (let p = start; p <= end; p++) pager.appendChild(makeLi(String(p), p, false, p === currentPage));
            pager.appendChild(makeLi('»', Math.min(totalPages, currentPage + 1), currentPage === totalPages, false));
        }

        if (searchInput) searchInput.addEventListener('keyup', renderPage.bind(null, 1));
        if (pageSizeSelect) pageSizeSelect.addEventListener('change', () => renderPage(1));

        renderPage(1);
    })();
</script>
</body>
</html>
