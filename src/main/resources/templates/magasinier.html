<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments/layout :: head"></head>
<body>
    <div th:replace="fragments/layout :: main(content=~{::content}, pageTitle=#{page.title.magasinier.dashboard})">
        <div th:fragment="content">
            <div class="d-flex justify-content-end mb-3">
                <a th:href="@{/magasinier/bon-entree}" class="btn btn-primary me-2">
                    <i class="bi bi-plus-circle"></i> <span th:text="#{button.entry.voucher}">Entry Voucher</span>
                </a>
                <a th:href="@{/magasinier/bons}" class="btn btn-secondary">
                    <i class="bi bi-list-ul"></i> <span th:text="#{button.voucher.list}">Voucher List</span>
                </a>
            </div>

            <div th:replace="fragments/layout :: alertMessage"></div>

            <!-- Statistic Cards -->
            <div class="row g-4 mb-4">
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title" th:text="#{text.total.products}">Total Products</h5>
                            <p class="card-text fs-4 fw-bold">1,234</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title" th:text="#{text.items.in.stock}">Items in Stock</h5>
                            <p class="card-text fs-4 fw-bold">5,678</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title" th:text="#{text.pending.requests}">Pending Requests</h5>
                            <p class="card-text fs-4 fw-bold" th:text="${#lists.size(requests)}">0</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-bottom border-light p-0">
                    <ul class="nav nav-tabs nav-fill border-0" id="dashboardTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active py-3 fw-bold text-dark border-0 border-bottom-3 border-primary rounded-0"
                                    id="requests-to-process-tab" data-bs-toggle="tab" data-bs-target="#requests-to-process"
                                    type="button" role="tab" aria-controls="requests-to-process" aria-selected="true">
                                <i class="bi bi-card-checklist me-2"></i><span th:text="#{text.requests.to.process}">Requests to Process</span>
                            </button>
                        </li>
                    </ul>
                </div>

                <div class="card-body p-0">
                    <div class="tab-content" id="dashboardTabsContent">
                        <!-- Requests to Process Tab -->
                        <div class="tab-pane fade show active" id="requests-to-process" role="tabpanel" aria-labelledby="requests-to-process-tab">
                            <div class="table-responsive">
                                <table class="table table-hover align-middle mb-0">
                                    <thead class="bg-light">
                                        <tr class="text-muted text-uppercase small" style="letter-spacing: 0.5px;">
                                            <th class="ps-4 py-3">ID</th>
                                            <th class="py-3" th:text="#{text.requester}">Requester</th>
                                            <th class="py-3" th:text="#{text.products}">Product(s)</th>
                                            <th class="py-3" th:text="#{text.date}">Date</th>
                                            <th class="py-3" th:text="#{text.status}">Status</th>
                                            <th class="py-3 text-end pe-4" th:text="#{text.action}">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="request : ${requests}">
                                            <td class="ps-4 fw-semibold text-secondary" th:text="${request.demande.id}">#1</td>
                                            <td th:text="${request.demandeurName}">User Name</td>
                                            <td>
                                                <ul class="mb-0 ps-3" th:if="${#lists.isEmpty(request.demande.lignes) == false}">
                                                    <li th:each="line : ${request.demande.lignes}"
                                                        th:text="${line.produit.nom + ' (x' + line.quantiteDemandee + ')'}">Product (xQ)</li>
                                                </ul>
                                                <span th:if="${#lists.isEmpty(request.demande.lignes)}" class="text-muted small" th:text="#{text.no.products}">No products</span>
                                            </td>
                                            <td th:text="${#temporals.format(request.demande.request_date, 'dd-MM-yyyy')}">2025-01-01</td>
                                            <td>
                                                <span class="badge bg-success text-white" th:text="${request.demande.etat_demande}">ACCEPTE_SG</span>
                                            </td>

                                            <td class="text-end pe-4">
                                                <div th:if="${request.demande.etat_demande != null and request.demande.etat_demande.name() == 'APPROVED'}">
                                                    <form th:action="@{/magasinier/request/deliver/{id}(id=${request.demande.id})}" method="post" style="display:inline;">
                                                        <button type="submit" class="btn btn-sm btn-outline-success" th:attr="onclick='return confirm(\'' + #{text.confirm.delivery} + '\');'">
                                                            <i class="bi bi-check-circle"></i> <span th:text="#{button.confirm.delivery}">Confirm Delivery</span>
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        <tr th:if="${#lists.isEmpty(requests)}">
                                            <td colspan="6" class="text-center py-4 text-muted" th:text="#{text.no.requests.to.process}">No accepted requests to process.</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const tabButtons = document.querySelectorAll('#dashboardTabs .nav-link');
            tabButtons.forEach(button => {
                button.addEventListener('click', function () {
                    tabButtons.forEach(btn => {
                        btn.classList.remove('active', 'border-primary');
                        btn.setAttribute('aria-selected', 'false');
                    });
                    this.classList.add('active', 'border-primary');
                    this.setAttribute('aria-selected', 'true');
                });
            });
        });
    </script>
</body>
</html>
