<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/layout :: head"></head>
<body>
    <div th:replace="fragments/layout :: main(content=~{::content}, pageTitle='Stock Management')">
        <div th:fragment="content">
            <div th:replace="fragments/layout :: alertMessage"></div>

            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="fw-bold text-dark">Stock Inventory</h2>
                    <p class="text-secondary mb-0">View and monitor product stock levels.</p>
                </div>
            </div>

            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="card-header bg-white border-bottom border-light p-4">
                    <div class="row g-3 align-items-center">
                        <div class="col-md-6">
                            <div class="position-relative">
                                <span class="position-absolute top-50 start-0 translate-middle-y ps-3 text-muted">
                                    <i class="bi bi-search"></i>
                                </span>
                                <input type="text" class="form-control form-control-lg border-light bg-light ps-5 rounded-pill"
                                       id="searchInput" placeholder="Search products...">
                            </div>
                        </div>
                        <div class="col-md-6 text-md-end">
                            <!-- Optional: Add filters here if needed -->
                        </div>
                    </div>
                </div>

                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table id="stockTable" class="table table-hover align-middle mb-0">
                            <thead class="bg-light">
                                <tr class="text-muted text-uppercase small" style="letter-spacing: 0.5px;">
                                    <th class="ps-4 py-3">ID</th>
                                    <th class="py-3">Product Name</th>
                                    <th class="py-3">Quantity</th>
                                    <th class="py-3">Alert Threshold</th>
                                    <th class="py-3">Unit Price</th>
                                    <th class="py-3">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="product : ${products}">
                                    <td class="ps-4 fw-semibold text-secondary" th:text="${product.id}">1</td>
                                    <td class="fw-bold text-dark" th:text="${product.nom}">Product Name</td>
                                    <td th:text="${product.quantite}">100</td>
                                    <td th:text="${product.seuilAlerte}">10</td>
                                    <td th:text="${product.prixUnitaire}">50.0</td>
                                    <td>
                                        <span th:if="${product.quantite <= product.seuilAlerte}" class="badge bg-danger-subtle text-danger border border-danger-subtle rounded-pill">Low Stock</span>
                                        <span th:unless="${product.quantite <= product.seuilAlerte}" class="badge bg-success-subtle text-success border border-success-subtle rounded-pill">In Stock</span>
                                    </td>
                                </tr>
                                <tr th:if="${#lists.isEmpty(products)}">
                                    <td colspan="6" class="text-center py-4 text-muted">No products found in inventory.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card-footer bg-white border-top border-light p-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-muted small">
                            Rows per page:
                            <select id="pageSize-stock" class="form-select form-select-sm d-inline-block border-0 bg-light" style="width:auto;">
                                <option value="5">5</option>
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                            </select>
                        </div>
                        <nav>
                            <ul id="pager-stock" class="pagination pagination-sm mb-0 gap-1"></ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tableBody = document.querySelector('#stockTable tbody');
      const searchInput = document.getElementById('searchInput');
      const pageSizeSelect = document.getElementById('pageSize-stock');
      const pager = document.getElementById('pager-stock');

      if (!tableBody || !searchInput || !pageSizeSelect || !pager) return;

      const debounce = (fn, delay) => { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); }; };
      const normalize = s => (s || '').toLowerCase().trim();

      let currentPage = 1;

      function matchesFilter(row) {
        const q = normalize(searchInput.value);
        const name = normalize(row.cells[1].textContent);
        return !q || name.includes(q);
      }

      function getFilteredRows() {
        return Array.from(tableBody.querySelectorAll('tr')).filter(matchesFilter);
      }

      function renderPager(totalPages) {
        pager.innerHTML = '';
        const makeLi = (text, page, disabled) => {
          const li = document.createElement('li');
          li.className = 'page-item' + (disabled ? ' disabled' : '') + (page === currentPage ? ' active' : '');
          const a = document.createElement('a'); a.className = 'page-link'; a.href = '#'; a.textContent = text;
          a.onclick = (e) => { e.preventDefault(); if (!disabled) renderPage(page); };
          li.appendChild(a); return li;
        };
        pager.appendChild(makeLi('«', Math.max(1, currentPage - 1), currentPage === 1));

        const maxWindow = 7;
        let start = Math.max(1, currentPage - Math.floor(maxWindow / 2));
        let end = Math.min(totalPages, start + maxWindow - 1);
        if (end - start + 1 < maxWindow) start = Math.max(1, end - maxWindow + 1);

        for (let p = start; p <= end; p++) pager.appendChild(makeLi(String(p), p, false));
        pager.appendChild(makeLi('»', Math.min(totalPages, currentPage + 1), currentPage === totalPages));
      }

      function renderPage(page = 1) {
        currentPage = page;
        const pageSize = parseInt(pageSizeSelect.value, 10) || 10;
        const filtered = getFilteredRows();

        Array.from(tableBody.querySelectorAll('tr')).forEach(r => r.style.display = 'none');

        const total = filtered.length;
        const totalPages = Math.max(1, Math.ceil(total / pageSize));
        const start = (page - 1) * pageSize;

        filtered.slice(start, start + pageSize).forEach(r => r.style.display = '');
        renderPager(totalPages);
      }

      const runner = debounce(() => renderPage(1), 120);
      searchInput.addEventListener('input', runner);
      pageSizeSelect.addEventListener('change', () => renderPage(1));

      // initial run
      renderPage(1);
    });
    </script>
</body>
</html>
